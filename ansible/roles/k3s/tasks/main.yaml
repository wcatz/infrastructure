---
# roles/k3s/tasks/main.yaml

- name: Download k3s installation script
  ansible.builtin.get_url:
    url: "{{ k3s_install_url }}"
    dest: /tmp/k3s-install.sh
    mode: '0755'

- name: Check if K3s certificate includes Tailscale IP
  ansible.builtin.shell: |
    if [ -f /var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt ]; then
      openssl x509 -in /var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt -text -noout | grep -q "{{ hostvars[inventory_hostname]['ansible_host'] }}"
      echo $?
    else
      echo 1
    fi
  register: cert_check
  become: true
  when: k3s_server_enabled
  changed_when: false

- name: Uninstall K3s if certificate is missing Tailscale IP
  ansible.builtin.command: /usr/local/bin/k3s-uninstall.sh
  become: true
  when:
    - k3s_server_enabled
    - cert_check.stdout | int != 0
  ignore_errors: true

- name: Install K3s server
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_TOKEN={{ k3s_token | default('') }} \
    sh /tmp/k3s-install.sh server {{ k3s_server_args | join(' ') }} \
    --node-name={{ inventory_hostname }} \
    --tls-san={{ hostvars[inventory_hostname]['ansible_host'] }} \
    {% if k3s_node_labels | length > 0 %}{% for label in k3s_node_labels %}--node-label={{ label }} {% endfor %}{% endif %}
  become: true
  when: k3s_server_enabled

- name: Install K3s agent
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_URL=https://{{ hostvars[groups['k3s_servers'][0]]['ansible_host'] }}:6443 \
    K3S_TOKEN={{ k3s_token }} \
    sh /tmp/k3s-install.sh agent \
    {% if k3s_node_labels | length > 0 %}{% for label in k3s_node_labels %}--node-label={{ label }} {% endfor %}{% endif %}
  become: true
  when: k3s_agent_enabled

- name: Wait for k3s.yaml to appear on server
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 300
  when: k3s_server_enabled

- name: Get local user home directory
  ansible.builtin.set_fact:
    local_home: "{{ lookup('env', 'HOME') }}"
  delegate_to: localhost
  run_once: true

- name: Ensure local .kube directory exists
  ansible.builtin.file:
    path: "{{ local_home }}/.kube"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true

- name: Copy kubeconfig to local machine
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ local_home }}/.kube/k3s-{{ inventory_hostname }}.yaml"
    flat: yes
    fail_on_missing: yes
  become: true
  when: k3s_server_enabled

- name: Patch kubeconfig to use Tailscale IP
  ansible.builtin.lineinfile:
    path: "{{ local_home }}/.kube/k3s-{{ inventory_hostname }}.yaml"
    regexp: '^\s+server:\s+https://.*:6443'
    line: "    server: https://{{ hostvars[inventory_hostname]['ansible_host'] }}:6443"
  delegate_to: localhost
  when: k3s_server_enabled

- name: Wait for node to be ready
  ansible.builtin.shell: |
    KUBECONFIG={{ local_home }}/.kube/k3s-{{ inventory_hostname }}.yaml \
    kubectl wait --for=condition=Ready node --all --timeout=300s
  delegate_to: localhost
  retries: 10
  delay: 15
  register: node_ready
  until: node_ready.rc == 0
  changed_when: false
  when: k3s_server_enabled

- name: Verify k3s installation
  ansible.builtin.command: k3s --version
  register: k3s_version_output
  changed_when: false

- name: Display k3s version
  ansible.builtin.debug:
    var: k3s_version_output.stdout
