---
# Tasks for k3s role

- name: Download k3s installation script
  ansible.builtin.get_url:
    url: "{{ k3s_install_url }}"
    dest: /tmp/k3s-install.sh
    mode: '0755'

- name: Install k3s server
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_TOKEN={{ k3s_token | default('') }} \
    sh /tmp/k3s-install.sh server {{ k3s_server_args | join(' ') }}
  args:
    creates: /usr/local/bin/k3s
  when: k3s_server_enabled
  notify: Restart k3s

- name: Wait for k3s to be ready
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 300
  when: k3s_server_enabled

- name: Create .kube directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    mode: '0755'
  when: k3s_server_enabled

- name: Copy kubeconfig to .kube/config
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ ansible_env.HOME }}/.kube/config"
    remote_src: true
    mode: '0600'
  when: k3s_server_enabled

- name: Validate k3s_token for agent installation
  ansible.builtin.assert:
    that:
      - k3s_token is defined
      - k3s_token | length > 0
    fail_msg: "k3s_token must be set for agent nodes"
  when: k3s_agent_enabled

- name: Install k3s agent
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_URL=https://{{ hostvars[groups['k3s_servers'][0]]['ansible_host'] }}:6443 \
    K3S_TOKEN={{ k3s_token }} \
    sh /tmp/k3s-install.sh agent
  args:
    creates: /usr/local/bin/k3s
  when: k3s_agent_enabled
  notify: Restart k3s

- name: Wait for node to be ready
  ansible.builtin.shell: |
    kubectl wait --for=condition=Ready node/$(hostname) --timeout=300s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  when: k3s_server_enabled or k3s_agent_enabled
  register: node_ready
  until: node_ready.rc == 0
  retries: 5
  delay: 10
  changed_when: false

- name: Apply control plane taint (no workloads on control plane)
  ansible.builtin.shell: |
    kubectl taint nodes $(hostname) node-role.kubernetes.io/control-plane=:NoSchedule --overwrite
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  when: k3s_server_enabled and (k3s_node_taint | default(false))
  changed_when: true

- name: Label worker nodes
  ansible.builtin.shell: |
    kubectl label nodes $(hostname) {{ k3s_node_label }} --overwrite
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  when: k3s_agent_enabled and k3s_node_label is defined
  changed_when: true

- name: Verify k3s installation
  ansible.builtin.command: k3s --version
  register: k3s_version_output
  changed_when: false

- name: Display k3s version
  ansible.builtin.debug:
    var: k3s_version_output.stdout
