---
# roles/k3s/tasks/main.yaml

- name: Download k3s installation script
  ansible.builtin.get_url:
    url: "{{ k3s_install_url }}"
    dest: /tmp/k3s-install.sh
    mode: '0755'

- name: Get Tailscale hostname
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  changed_when: false
  when: k3s_server_enabled

- name: Extract Tailscale hostname
  ansible.builtin.set_fact:
    tailscale_hostname: "{{ (tailscale_status.stdout | from_json).Self.DNSName | regex_replace('\\.

- name: Install K3s agent
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_URL=https://{{ hostvars[groups['k3s_servers'][0]]['ansible_host'] }}:6443 \
    K3S_TOKEN={{ k3s_token }} \
    sh /tmp/k3s-install.sh agent \
    {% if k3s_node_labels | length > 0 %}{% for label in k3s_node_labels %}--node-label={{ label }} {% endfor %}{% endif %}
  args:
    creates: /usr/local/bin/k3s
  become: true
  when: k3s_agent_enabled

- name: Wait for k3s.yaml to appear on server
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 300
  when: k3s_server_enabled

# Ensure local .kube directory exists
- name: Ensure local .kube directory exists
  ansible.builtin.file:
    path: "{{ lookup('env','HOME') }}/.kube"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true

# Fetch kubeconfig to local machine
- name: Copy kubeconfig to local machine
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ lookup('env','HOME') }}/.kube/k3s-{{ inventory_hostname }}.yaml"
    flat: yes
    fail_on_missing: yes
  become: true
  when: k3s_server_enabled

# Patch kubeconfig to use Tailscale IP
- name: Patch kubeconfig to use Tailscale IP
  ansible.builtin.lineinfile:
    path: "{{ lookup('env','HOME') }}/.kube/k3s-{{ inventory_hostname }}.yaml"
    regexp: '^\s+server:\s+https://.*:6443'
    line: "    server: https://{{ hostvars[inventory_hostname]['ansible_host'] }}:6443"
  delegate_to: localhost
  when: k3s_server_enabled

# Get the actual node hostname
- name: Get node hostname
  ansible.builtin.command: hostname -f
  register: node_hostname
  changed_when: false
  when: k3s_server_enabled

# Wait for the node to be ready using Tailscale IP
- name: Wait for node to be ready
  ansible.builtin.shell: |
    KUBECONFIG={{ lookup('env','HOME') }}/.kube/k3s-{{ inventory_hostname }}.yaml \
    kubectl wait --for=condition=Ready node/{{ inventory_hostname }} --timeout=300s
  delegate_to: localhost
  retries: 10
  delay: 15
  register: node_ready
  until: node_ready.rc == 0
  changed_when: false
  when: k3s_server_enabled

# Verify K3s installation
- name: Verify k3s installation
  ansible.builtin.command: k3s --version
  register: k3s_version_output
  changed_when: false

- name: Display k3s version
  ansible.builtin.debug:
    var: k3s_version_output.stdout
, '') }}"
  when: k3s_server_enabled

- name: Check if K3s certificate includes Tailscale IP
  ansible.builtin.shell: |
    if [ -f /var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt ]; then
      openssl x509 -in /var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt -text -noout | grep -q "{{ hostvars[inventory_hostname]['ansible_host'] }}"
      echo $?
    else
      echo 1
    fi
  register: cert_check
  become: true
  when: k3s_server_enabled
  changed_when: false

- name: Uninstall K3s if certificate is missing Tailscale IP
  ansible.builtin.command: /usr/local/bin/k3s-uninstall.sh
  become: true
  when: 
    - k3s_server_enabled
    - cert_check.stdout | int != 0
  ignore_errors: true

- name: Install K3s server
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_TOKEN={{ k3s_token | default('') }} \
    sh /tmp/k3s-install.sh server {{ k3s_server_args | join(' ') }} \
    --node-name={{ inventory_hostname }} \
    --tls-san={{ hostvars[inventory_hostname]['ansible_host'] }} \
    {% if k3s_node_labels | length > 0 %}{% for label in k3s_node_labels %}--node-label={{ label }} {% endfor %}{% endif %}
  become: true
  when: k3s_server_enabled

- name: Install K3s agent
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION={{ k3s_version }} \
    K3S_URL=https://{{ hostvars[groups['k3s_servers'][0]]['ansible_host'] }}:6443 \
    K3S_TOKEN={{ k3s_token }} \
    sh /tmp/k3s-install.sh agent \
    {% if k3s_node_labels | length > 0 %}{% for label in k3s_node_labels %}--node-label={{ label }} {% endfor %}{% endif %}
  args:
    creates: /usr/local/bin/k3s
  become: true
  when: k3s_agent_enabled

- name: Wait for k3s.yaml to appear on server
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 300
  when: k3s_server_enabled

# Ensure local .kube directory exists
- name: Ensure local .kube directory exists
  ansible.builtin.file:
    path: "{{ lookup('env','HOME') }}/.kube"
    state: directory
    mode: '0755'
  delegate_to: localhost
  run_once: true

# Fetch kubeconfig to local machine
- name: Copy kubeconfig to local machine
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ lookup('env','HOME') }}/.kube/k3s-{{ inventory_hostname }}.yaml"
    flat: yes
    fail_on_missing: yes
  become: true
  when: k3s_server_enabled

# Patch kubeconfig to use Tailscale IP
- name: Patch kubeconfig to use Tailscale IP
  ansible.builtin.lineinfile:
    path: "{{ lookup('env','HOME') }}/.kube/k3s-{{ inventory_hostname }}.yaml"
    regexp: '^\s+server:\s+https://.*:6443'
    line: "    server: https://{{ hostvars[inventory_hostname]['ansible_host'] }}:6443"
  delegate_to: localhost
  when: k3s_server_enabled

# Get the actual node hostname
- name: Get node hostname
  ansible.builtin.command: hostname -f
  register: node_hostname
  changed_when: false
  when: k3s_server_enabled

# Wait for the node to be ready using Tailscale IP
- name: Wait for node to be ready
  ansible.builtin.shell: |
    KUBECONFIG={{ lookup('env','HOME') }}/.kube/k3s-{{ inventory_hostname }}.yaml \
    kubectl wait --for=condition=Ready node/{{ node_hostname.stdout }} --timeout=300s
  delegate_to: localhost
  retries: 10
  delay: 15
  register: node_ready
  until: node_ready.rc == 0
  changed_when: false
  when: k3s_server_enabled

# Verify K3s installation
- name: Verify k3s installation
  ansible.builtin.command: k3s --version
  register: k3s_version_output
  changed_when: false

- name: Display k3s version
  ansible.builtin.debug:
    var: k3s_version_output.stdout