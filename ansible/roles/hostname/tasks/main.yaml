---
# roles/hostname/tasks/main.yaml
# Configure system hostname according to naming convention

- name: Ensure hostname is defined
  ansible.builtin.assert:
    that:
      - hostname is defined
      - hostname | length > 0
    fail_msg: "hostname variable must be defined"

- name: Set system hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
  become: true

- name: Update /etc/hostname
  ansible.builtin.copy:
    content: "{{ hostname }}\n"
    dest: /etc/hostname
    mode: '0644'
  become: true

- name: Update /etc/hosts with new hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ hostname }}{% if domain is defined %}.{{ domain }} {{ hostname }}{% endif %}"
    state: present
  become: true

- name: Ensure localhost entries exist in /etc/hosts
  ansible.builtin.blockinfile:
    path: /etc/hosts
    block: |
      127.0.0.1 localhost
      ::1 localhost ip6-localhost ip6-loopback
    marker: "# {mark} ANSIBLE MANAGED BLOCK - localhost"
    insertbefore: BOF
  become: true

- name: Verify hostname was set correctly
  ansible.builtin.command: hostname
  register: current_hostname
  changed_when: false

- name: Display configured hostname
  ansible.builtin.debug:
    msg: "Hostname configured: {{ current_hostname.stdout }}"
