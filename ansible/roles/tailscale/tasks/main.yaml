---
# roles/tailscale/tasks/main.yaml

- name: Validate tailscale_auth_key is defined
  ansible.builtin.assert:
    that:
      - tailscale_auth_key is defined
      - tailscale_auth_key | length > 0
    fail_msg: "tailscale_auth_key variable must be defined"

# Skip installation if Tailscale is already installed
- name: Check if Tailscale is installed
  ansible.builtin.command: tailscale version
  register: tailscale_check
  ignore_errors: true
  changed_when: false

- name: Install Tailscale via official install script
  ansible.builtin.shell: |
    curl -fsSL https://tailscale.com/install.sh | sh
  args:
    warn: false
  become: yes
  when: tailscale_check.rc != 0
  register: tailscale_install
  changed_when: "'already installed' not in tailscale_install.stdout"

# Ensure tailscaled service is enabled and running
- name: Enable Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  become: true

# Build Tailscale up command
- name: Build Tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: >-
      tailscale up --authkey={{ tailscale_auth_key }}
      {{ tailscale_args | default('') }}
      {% if tailscale_enable_ssh | default(false) %}--ssh{% endif %}
      {% if not tailscale_accept_dns | default(true) %}--accept-dns=false{% endif %}
      {% if tailscale_advertise_tags is defined and tailscale_advertise_tags | length > 0 %}
      --advertise-tags={{ tailscale_advertise_tags | join(',') }}
      {% endif %}

- name: Connect to Tailscale
  ansible.builtin.command: "{{ tailscale_up_cmd }}"
  become: true
  register: tailscale_up_result
  changed_when: "'Success' in tailscale_up_result.stdout or 'Success' in tailscale_up_result.stderr"
  notify: Restart tailscaled


# Get Tailscale status
- name: Get Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  become: true

- name: Display Tailscale status
  ansible.builtin.debug:
    var: tailscale_status.stdout_lines
