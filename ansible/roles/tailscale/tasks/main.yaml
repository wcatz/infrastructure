---
# Tasks for Tailscale role

- name: Validate tailscale_auth_key is defined
  ansible.builtin.assert:
    that:
      - tailscale_auth_key is defined
      - tailscale_auth_key | length > 0
    fail_msg: "tailscale_auth_key variable must be defined"

- name: Add Tailscale GPG key (Debian/Ubuntu)
  ansible.builtin.get_url:
    url: https://pkgs.tailscale.com/stable/debian/{{ ansible_distribution_release }}.noarmor.gpg
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: '0644'
  become: true
  when: ansible_os_family == "Debian"

- name: Add Tailscale repository (Debian/Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/debian {{ ansible_distribution_release }} main"
    state: present
    filename: tailscale
  become: true
  when: ansible_os_family == "Debian"

- name: Install Tailscale (Debian/Ubuntu)
  ansible.builtin.apt:
    name: tailscale
    state: "{% if tailscale_version == 'latest' %}latest{% else %}present{% endif %}"
    update_cache: true
  become: true
  when: ansible_os_family == "Debian"

- name: Add Tailscale repository (RedHat/CentOS)
  ansible.builtin.yum_repository:
    name: tailscale-stable
    description: Tailscale stable
    baseurl: https://pkgs.tailscale.com/stable/centos/$releasever/$basearch
    enabled: true
    gpgcheck: true
    gpgkey: https://pkgs.tailscale.com/stable/centos/$releasever/repo.gpg
  become: true
  when: ansible_os_family == "RedHat"

- name: Install Tailscale (RedHat/CentOS)
  ansible.builtin.yum:
    name: tailscale
    state: "{% if tailscale_version == 'latest' %}latest{% else %}present{% endif %}"
  become: true
  when: ansible_os_family == "RedHat"

- name: Enable Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  become: true

- name: Build Tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: >-
      tailscale up --authkey={{ tailscale_auth_key }}
      {{ tailscale_args }}
      {% if tailscale_enable_ssh %}--ssh{% endif %}
      {% if not tailscale_accept_dns %}--accept-dns=false{% endif %}
      {% if tailscale_advertise_tags | length > 0 %}--advertise-tags={{ tailscale_advertise_tags | join(',') }}{% endif %}

- name: Connect to Tailscale
  ansible.builtin.command: "{{ tailscale_up_cmd }}"
  become: true
  register: tailscale_up_result
  changed_when: "'Success' in tailscale_up_result.stdout or 'Success' in tailscale_up_result.stderr"
  notify: Restart tailscaled

- name: Get Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  become: true

- name: Display Tailscale status
  ansible.builtin.debug:
    var: tailscale_status.stdout_lines
