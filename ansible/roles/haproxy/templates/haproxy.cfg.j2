global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

{% if haproxy_ssl_enabled %}
    # SSL/TLS configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
{% endif %}

    # Performance tuning
    maxconn {{ haproxy_global_maxconn }}

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect {{ haproxy_defaults_timeout_connect }}
    timeout client  {{ haproxy_defaults_timeout_client }}
    timeout server  {{ haproxy_defaults_timeout_server }}
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

{% if haproxy_stats_enabled %}
# HAProxy Statistics Interface
listen stats
    bind *:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri {{ haproxy_stats_uri }}
    stats refresh {{ haproxy_stats_refresh }}
    stats admin if LOCALHOST
    stats show-legends
    stats show-node
{% endif %}

{% for service in haproxy_services %}
# {{ service.name | upper }} Load Balancer
frontend {{ service.name }}_frontend
    bind *:{{ service.frontend_port }}
    mode {{ service.mode }}
    default_backend {{ service.name }}_backend

backend {{ service.name }}_backend
    mode {{ service.mode }}
    balance {{ service.balance | default('roundrobin') }}
    option tcp-check
{% for worker in k3s_workers %}
    server {{ worker.name }} {{ worker.host }}:{{ service.backend_port }} check inter {{ service.check_interval | default('2s') }} fall 3 rise 2{% if service.check_timeout is defined %} timeout {{ service.check_timeout }}{% endif %}

{% endfor %}

{% endfor %}
