# HAProxy Configuration File
# Generated by Ansible - DO NOT EDIT MANUALLY
# Environment: {{ haproxy_environment | default('prod') }}

global
    log {{ haproxy_global.log_socket }} local0 {{ haproxy_global.log_level }}
    maxconn {{ haproxy_global.maxconn }}
    stats socket {{ haproxy_global.stats_socket }} mode 660 level {{ haproxy_global.stats_level }}
    user haproxy
    group haproxy
    daemon
{% if haproxy_global.ssl_default_bind_options is defined %}
    # SSL/TLS settings
    ssl-default-bind-options {{ haproxy_global.ssl_default_bind_options }}
{% endif %}

defaults
    mode {{ haproxy_defaults.mode }}
    log {{ haproxy_defaults.log }}
{% if haproxy_defaults.option_tcplog %}
    option tcplog
{% endif %}
    option dontlognull
    timeout connect {{ haproxy_defaults.timeout_connect }}
    timeout client {{ haproxy_defaults.timeout_client }}
    timeout server {{ haproxy_defaults.timeout_server }}
    retries {{ haproxy_defaults.retries }}
{% if haproxy_defaults.timeout_queue is defined %}
    timeout queue {{ haproxy_defaults.timeout_queue }}
{% endif %}
{% if haproxy_defaults.timeout_check is defined %}
    timeout check {{ haproxy_defaults.timeout_check }}
{% endif %}

# Statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
{% if haproxy_stats_auth is defined %}
    stats auth {{ haproxy_stats_auth.username }}:{{ haproxy_stats_auth.password }}
{% endif %}

{% if haproxy_tcp_backends is defined %}
# TCP Backend Configurations
{% for backend in haproxy_tcp_backends %}
frontend {{ backend.name }}_frontend
    bind *:{{ backend.port }}
    mode {{ backend.mode }}
    default_backend {{ backend.name }}_backend
{% if backend.maxconn is defined %}
    maxconn {{ backend.maxconn }}
{% endif %}

backend {{ backend.name }}_backend
    mode {{ backend.mode }}
    balance {{ backend.balance }}
{% if backend.timeout_server is defined %}
    timeout server {{ backend.timeout_server }}
{% endif %}
{% if backend.timeout_connect is defined %}
    timeout connect {{ backend.timeout_connect }}
{% endif %}
    # Failover configuration - only add tcp-check if any server has health checks enabled
{% set has_health_checks = false %}
{% for server in backend.servers %}
{% if server.check | default(false) %}
{% set has_health_checks = true %}
{% endif %}
{% endfor %}
{% if has_health_checks %}
    option tcp-check
{% if backend.tcp_check_connect is defined and backend.tcp_check_connect %}
    tcp-check connect
{% endif %}
{% if backend.tcp_check_send is defined %}
    tcp-check send {{ backend.tcp_check_send }}
{% endif %}
{% if backend.tcp_check_expect is defined %}
    tcp-check expect {{ backend.tcp_check_expect }}
{% endif %}
{% endif %}
{% if backend.option_httpchk is defined %}
    option httpchk {{ backend.option_httpchk }}
{% endif %}
{% for server in backend.servers %}
    server {{ server.name }} {{ server.address }}:{{ server.port }}
{%- if server.check | default(false) %} check
{%- if server.check_interval is defined %} inter {{ server.check_interval }}{% endif %}
{%- if server.rise is defined %} rise {{ server.rise }}{% endif %}
{%- if server.fall is defined %} fall {{ server.fall }}{% endif %}
{%- if server.maxconn is defined %} maxconn {{ server.maxconn }}{% endif %}
{%- if server.weight is defined %} weight {{ server.weight }}{% endif %}
{%- if server.backup is defined and server.backup %} backup{% endif %}
{%- endif %}

{% endfor %}
{% endfor %}
{% endif %}

{% if haproxy_udp_backends is defined %}
# UDP Backend Configurations
{% for backend in haproxy_udp_backends %}
frontend {{ backend.name }}_frontend
    bind *:{{ backend.port }} proto udp
    mode {{ backend.mode }}
    default_backend {{ backend.name }}_backend
{% if backend.maxconn is defined %}
    maxconn {{ backend.maxconn }}
{% endif %}

backend {{ backend.name }}_backend
    mode {{ backend.mode }}
    balance {{ backend.balance }}
{% if backend.timeout_server is defined %}
    timeout server {{ backend.timeout_server }}
{% endif %}
{% for server in backend.servers %}
    server {{ server.name }} {{ server.address }}:{{ server.port }}
{%- if server.weight is defined %} weight {{ server.weight }}{% endif %}
{%- if server.maxconn is defined %} maxconn {{ server.maxconn }}{% endif %}
{%- if server.backup is defined and server.backup %} backup{% endif %}

{% endfor %}

{% endfor %}
{% endif %}
