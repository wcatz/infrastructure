# HAProxy Configuration File
# Generated by Ansible - DO NOT EDIT MANUALLY

global
    log {{ haproxy_global.log_socket }} local0 {{ haproxy_global.log_level }}
    maxconn {{ haproxy_global.maxconn }}
    stats socket {{ haproxy_global.stats_socket }} mode 660 level {{ haproxy_global.stats_level }}
    user haproxy
    group haproxy
    daemon

defaults
    mode {{ haproxy_defaults.mode }}
    log {{ haproxy_defaults.log }}
{% if haproxy_defaults.option_tcplog %}
    option tcplog
{% endif %}
    option dontlognull
    timeout connect {{ haproxy_defaults.timeout_connect }}
    timeout client {{ haproxy_defaults.timeout_client }}
    timeout server {{ haproxy_defaults.timeout_server }}
    retries {{ haproxy_defaults.retries }}

# Statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node

{% if haproxy_tcp_backends is defined %}
# TCP Backend Configurations
{% for backend in haproxy_tcp_backends %}
frontend {{ backend.name }}_frontend
    bind *:{{ backend.port }}
    mode {{ backend.mode }}
    default_backend {{ backend.name }}_backend

backend {{ backend.name }}_backend
    mode {{ backend.mode }}
    balance {{ backend.balance }}
{% for server in backend.servers %}
    server {{ server.name }} {{ server.address }}:{{ server.port }}
{%- if server.check | default(false) %} check
{%- if server.check_interval is defined %} inter {{ server.check_interval }}{% endif %}
{%- endif %}

{% endfor %}
{% endfor %}
{% endif %}

{% if haproxy_udp_backends is defined %}
# UDP Backend Configurations
{% for backend in haproxy_udp_backends %}
frontend {{ backend.name }}_frontend
    bind *:{{ backend.port }} proto udp
    mode {{ backend.mode }}
    default_backend {{ backend.name }}_backend

backend {{ backend.name }}_backend
    mode {{ backend.mode }}
    balance {{ backend.balance }}
{% for server in backend.servers %}
    server {{ server.name }} {{ server.address }}:{{ server.port }}
{% endfor %}

{% endfor %}
{% endif %}
