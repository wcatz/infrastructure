---
# HAProxy Deployment Playbook
# This playbook deploys HAProxy load balancer for NodePort services

- name: Deploy HAProxy Load Balancer
  hosts: haproxy_servers
  become: true

  roles:
    - haproxy

  tasks:
    - name: Display HAProxy configuration summary
      ansible.builtin.debug:
        msg: |
          HAProxy deployed successfully!
          
          Services configured:
          {% for service in haproxy_services %}
          - {{ service.name }}: {{ service.frontend_port }} -> {{ service.backend_port }}
          {% endfor %}
          
          Stats interface: http://{{ ansible_host }}:{{ haproxy_stats_port }}{{ haproxy_stats_uri }}
          
          Backend servers:
          {% for worker in k3s_workers %}
          - {{ worker.name }}: {{ worker.host }}
          {% endfor %}

    - name: Verify HAProxy is listening on configured ports
      ansible.builtin.wait_for:
        port: "{{ item.frontend_port }}"
        timeout: 30
        state: started
      loop: "{{ haproxy_services }}"
      when: haproxy_services | length > 0
