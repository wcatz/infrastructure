  # Determine safe base/head values (prefer SHAs for PRs/pushes)
  - name: Determine scan base/head
    id: revs
    run: |
      if [ "${{ github.event_name }}" = "pull_request" ]; then
        echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
        echo "head=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
      elif [ "${{ github.event_name }}" = "push" ]; then
        echo "base=${{ github.event.before }}" >> $GITHUB_OUTPUT
        echo "head=${{ github.sha }}" >> $GITHUB_OUTPUT
      else
        # For schedule / workflow_dispatch fall back to default branch & HEAD
        echo "base=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
        echo "head=HEAD" >> $GITHUB_OUTPUT
      fi

  # Ensure the PR base branch is available locally so trufflehog can resolve it
  - name: Fetch PR base branch (if PR)
    if: github.event_name == 'pull_request'
    run: |
      echo "Fetching base branch: ${{ github.event.pull_request.base.ref }}"
      git fetch origin ${{ github.event.pull_request.base.ref }}:refs/heads/${{ github.event.pull_request.base.ref }}

  # Ensure default branch is available for scheduled / manual runs that use branch names
  - name: Fetch default branch (if needed)
    if: github.event_name != 'pull_request' && github.event_name != 'push'
    run: |
      echo "Fetching default branch: ${{ github.event.repository.default_branch }}"
      git fetch origin ${{ github.event.repository.default_branch }}:refs/heads/${{ github.event.repository.default_branch }}

  - name: TruffleHog OSS
    uses: trufflesecurity/trufflehog@main
    # Skip the trufflehog step when base == head (nothing to diff)
    if: steps.revs.outputs.base != steps.revs.outputs.head
    with:
      path: ./
      base: ${{ steps.revs.outputs.base }}
      head: ${{ steps.revs.outputs.head }}
      extra_args: --debug --only-verified

  # Make sure a SARIF file exists (create a minimal SARIF if necessary) so later steps can inspect it
  - name: Ensure SARIF exists
    if: always()
    run: |
      if [ ! -f results.sarif ]; then
        echo '{"version":"2.1.0","runs":[]}' > results.sarif
        echo "Created minimal results.sarif (no findings)"
      else
        echo "results.sarif present"
      fi

  - name: Check SARIF has runs
    id: sarif_check
    run: |
      if ! command -v jq >/dev/null 2>&1; then
        sudo apt-get update -y
        sudo apt-get install -y jq
      fi
      if [ -f results.sarif ]; then
        runs=$(jq '.runs | length' results.sarif)
      else
        runs=0
      fi
      echo "runs=$runs" >> $GITHUB_OUTPUT

  - name: Upload TruffleHog results to Security tab
    uses: github/codeql-action/upload-sarif@v3
    if: steps.sarif_check.outputs.runs != '0'
    with:
      sarif_file: results.sarif
      category: trufflehog

  - name: No SARIF to upload - add summary
    if: steps.sarif_check.outputs.runs == '0'
    run: |
      echo "No TruffleHog SARIF results to upload (no runs found)." >> $GITHUB_STEP_SUMMARY

  - name: TruffleHog Summary
    if: always()
    run: |
      echo "## ðŸ” TruffleHog Secrets Scan Summary" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "**Scan completed at**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "### Security Recommendations" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "- All secrets should be encrypted with SOPS before commit" >> $GITHUB_STEP_SUMMARY
      echo "- Use Ansible Vault for infrastructure secrets" >> $GITHUB_STEP_SUMMARY
      echo "- Store secrets in Kubernetes Secrets or external secret managers" >> $GITHUB_STEP_SUMMARY
      echo "- Never commit plaintext credentials to Git" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "See [SECRETS.md](SECRETS.md) for secret management best practices." >> $GITHUB_STEP_SUMMARY