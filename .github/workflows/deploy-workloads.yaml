name: Deploy Workloads

'on':
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy workloads to'
        required: true
        default: 'production'
        type: choice
        options:
          - dev
          - staging
          - production
      workload:
        description: 'Workload to deploy'
        required: true
        type: choice
        options:
          - all
          - cardano-node

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate workload manifests
        run: |
          echo "Validating workload manifests..."
          yamllint helmfile/manifests/workloads/
          echo "✅ Workload manifest validation passed"

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Setup SOPS
        run: |
          wget -O /usr/local/bin/sops https://github.com/mozilla/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
          chmod +x /usr/local/bin/sops
          sops --version

      - name: Configure SOPS Age Key
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          mkdir -p ~/.config/sops/age
          echo "$SOPS_AGE_KEY" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Configure Kubernetes Context
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl cluster-info

      - name: Deploy Cardano Node
        if: |
          github.event.inputs.workload == 'cardano-node' ||
          github.event.inputs.workload == 'all'
        run: |
          echo "Deploying Cardano node workload..."
          kubectl apply -f helmfile/manifests/workloads/cardano-node.yaml

          echo "Waiting for Cardano node deployment to be ready..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/cardano-node -n cardano || true

          echo "Cardano node deployment status:"
          kubectl get pods -n cardano
          kubectl get svc -n cardano

      - name: Verify Deployment
        run: |
          echo "Verifying workload deployment..."

          if [ "${{ github.event.inputs.workload }}" = "cardano-node" ] || \
             [ "${{ github.event.inputs.workload }}" = "all" ]; then
            echo "Cardano node status:"
            kubectl get all -n cardano
            kubectl describe deployment cardano-node -n cardano
          fi

      - name: Deployment Summary
        run: |
          echo "✅ Workload deployment completed"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Workload: ${{ github.event.inputs.workload }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
