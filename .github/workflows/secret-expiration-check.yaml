name: Secret Expiration Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggers

jobs:
  check-secret-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Age Key Rotation Status
        id: age-key-check
        run: |
          echo "Checking age key rotation status..."
          
          # Check if rotation tracking file exists
          ROTATION_FILE=".github/secret-rotation-tracker.yaml"
          
          if [ ! -f "$ROTATION_FILE" ]; then
            echo "âš ï¸  Warning: Rotation tracker file not found"
            echo "Creating template at $ROTATION_FILE"
            cat > "$ROTATION_FILE" <<EOF
          # Secret Rotation Tracker
          # Update dates after each rotation
          
          age_key:
            last_rotated: "2024-01-01"  # YYYY-MM-DD format
            rotation_frequency_days: 90
          
          ansible_vault:
            last_rotated: "2024-01-01"  # YYYY-MM-DD format
            rotation_frequency_days: 365
          EOF
            echo "status=missing" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Parse YAML and check rotation status
          # This is a simple check - for production, use yq or similar
          AGE_LAST=$(grep -A1 "age_key:" "$ROTATION_FILE" | grep "last_rotated:" | cut -d'"' -f2)
          VAULT_LAST=$(grep -A1 "ansible_vault:" "$ROTATION_FILE" | grep "last_rotated:" | cut -d'"' -f2)
          
          # Calculate days since last rotation
          if [ -n "$AGE_LAST" ]; then
            AGE_DAYS=$(( ($(date +%s) - $(date -d "$AGE_LAST" +%s)) / 86400 ))
            echo "Age key last rotated $AGE_DAYS days ago"
            
            if [ $AGE_DAYS -gt 90 ]; then
              echo "age_status=overdue" >> $GITHUB_OUTPUT
              echo "age_days=$AGE_DAYS" >> $GITHUB_OUTPUT
              echo "âš ï¸  Age key rotation is OVERDUE by $(($AGE_DAYS - 90)) days!"
            elif [ $AGE_DAYS -gt 76 ]; then
              echo "age_status=warning" >> $GITHUB_OUTPUT
              echo "age_days=$AGE_DAYS" >> $GITHUB_OUTPUT
              echo "âš ï¸  Age key rotation due in $(( 90 - $AGE_DAYS )) days"
            else
              echo "age_status=ok" >> $GITHUB_OUTPUT
              echo "age_days=$AGE_DAYS" >> $GITHUB_OUTPUT
              echo "âœ… Age key rotation not due yet"
            fi
          fi
          
          if [ -n "$VAULT_LAST" ]; then
            VAULT_DAYS=$(( ($(date +%s) - $(date -d "$VAULT_LAST" +%s)) / 86400 ))
            echo "Ansible Vault password last rotated $VAULT_DAYS days ago"
            
            if [ $VAULT_DAYS -gt 365 ]; then
              echo "vault_status=overdue" >> $GITHUB_OUTPUT
              echo "vault_days=$VAULT_DAYS" >> $GITHUB_OUTPUT
              echo "âš ï¸  Ansible Vault password rotation is OVERDUE by $(($VAULT_DAYS - 365)) days!"
            elif [ $VAULT_DAYS -gt 335 ]; then
              echo "vault_status=warning" >> $GITHUB_OUTPUT
              echo "vault_days=$VAULT_DAYS" >> $GITHUB_OUTPUT
              echo "âš ï¸  Ansible Vault password rotation due in $(( 365 - $VAULT_DAYS )) days"
            else
              echo "vault_status=ok" >> $GITHUB_OUTPUT
              echo "vault_days=$VAULT_DAYS" >> $GITHUB_OUTPUT
              echo "âœ… Ansible Vault password rotation not due yet"
            fi
          fi

      - name: Check .sops.yaml Configuration
        id: sops-check
        run: |
          echo "Checking SOPS configuration..."
          
          if [ ! -f ".sops.yaml" ]; then
            echo "âš ï¸  Warning: .sops.yaml not found"
            echo "sops_status=missing" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Count number of age keys configured
          AGE_KEYS=$(grep -c "age1" .sops.yaml || echo "0")
          echo "Number of age keys in .sops.yaml: $AGE_KEYS"
          echo "age_key_count=$AGE_KEYS" >> $GITHUB_OUTPUT
          
          if [ "$AGE_KEYS" -eq "0" ]; then
            echo "âš ï¸  Warning: No age keys found in .sops.yaml"
            echo "sops_status=no_keys" >> $GITHUB_OUTPUT
          else
            echo "âœ… SOPS configuration found with $AGE_KEYS key(s)"
            echo "sops_status=ok" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Issue for Overdue Rotations
        if: steps.age-key-check.outputs.age_status == 'overdue' || steps.age-key-check.outputs.vault_status == 'overdue'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ageStatus = '${{ steps.age-key-check.outputs.age_status }}';
            const vaultStatus = '${{ steps.age-key-check.outputs.vault_status }}';
            const ageDays = '${{ steps.age-key-check.outputs.age_days }}';
            const vaultDays = '${{ steps.age-key-check.outputs.vault_days }}';
            
            let body = `# ðŸ” Secret Rotation Overdue\n\n`;
            body += `This is an automated alert about overdue secret rotations.\n\n`;
            
            if (ageStatus === 'overdue') {
              const overdueDays = ageDays - 90;
              body += `## âš ï¸ Age Encryption Key - OVERDUE\n\n`;
              body += `- **Status**: Overdue by ${overdueDays} days\n`;
              body += `- **Last Rotated**: ${ageDays} days ago\n`;
              body += `- **Policy**: Rotate every 90 days\n`;
              body += `- **Action Required**: Rotate immediately\n\n`;
              body += `### Rotation Steps\n\n`;
              body += `See [SECRETS.md - Age Key Rotation](SECRETS.md#age-key-rotation) for detailed steps.\n\n`;
            }
            
            if (vaultStatus === 'overdue') {
              const overdueDays = vaultDays - 365;
              body += `## âš ï¸ Ansible Vault Password - OVERDUE\n\n`;
              body += `- **Status**: Overdue by ${overdueDays} days\n`;
              body += `- **Last Rotated**: ${vaultDays} days ago\n`;
              body += `- **Policy**: Rotate annually (365 days)\n`;
              body += `- **Action Required**: Rotate immediately\n\n`;
              body += `### Rotation Steps\n\n`;
              body += `See [SECRETS.md - Ansible Vault Password Rotation](SECRETS.md#ansible-vault-password-rotation) for detailed steps.\n\n`;
            }
            
            body += `---\n\n`;
            body += `**Note**: After rotating secrets, update the rotation tracker file:\n`;
            body += `\`\`\`bash\n`;
            body += `# Update .github/secret-rotation-tracker.yaml with new dates\n`;
            body += `# Then commit and push the changes\n`;
            body += `\`\`\`\n\n`;
            body += `This check runs automatically every Monday at 9 AM UTC.\n`;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,secret-rotation'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Secret Rotation Overdue')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ” Secret Rotation Overdue',
                body: body,
                labels: ['security', 'secret-rotation', 'high-priority']
              });
              console.log('Created new issue for overdue rotations');
            }

      - name: Create Warning Comment for Upcoming Rotations
        if: |
          (steps.age-key-check.outputs.age_status == 'warning' || 
           steps.age-key-check.outputs.vault_status == 'warning') &&
          steps.age-key-check.outputs.age_status != 'overdue' &&
          steps.age-key-check.outputs.vault_status != 'overdue'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ageStatus = '${{ steps.age-key-check.outputs.age_status }}';
            const vaultStatus = '${{ steps.age-key-check.outputs.vault_status }}';
            const ageDays = '${{ steps.age-key-check.outputs.age_days }}';
            const vaultDays = '${{ steps.age-key-check.outputs.vault_days }}';
            
            console.log('ðŸ“‹ Secret Rotation Reminder');
            
            if (ageStatus === 'warning') {
              const daysRemaining = 90 - ageDays;
              console.log(`âš ï¸  Age key rotation due in ${daysRemaining} days`);
            }
            
            if (vaultStatus === 'warning') {
              const daysRemaining = 365 - vaultDays;
              console.log(`âš ï¸  Ansible Vault password rotation due in ${daysRemaining} days`);
            }

      - name: Summary
        run: |
          echo "## Secret Rotation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Age Key Status
          if [ "${{ steps.age-key-check.outputs.age_status }}" = "overdue" ]; then
            echo "âŒ **Age Key**: OVERDUE (${{ steps.age-key-check.outputs.age_days }} days old)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.age-key-check.outputs.age_status }}" = "warning" ]; then
            echo "âš ï¸  **Age Key**: Rotation due soon ($(( 90 - ${{ steps.age-key-check.outputs.age_days }} )) days remaining)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.age-key-check.outputs.age_status }}" = "ok" ]; then
            echo "âœ… **Age Key**: OK (${{ steps.age-key-check.outputs.age_days }} days old)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Vault Password Status
          if [ "${{ steps.age-key-check.outputs.vault_status }}" = "overdue" ]; then
            echo "âŒ **Ansible Vault**: OVERDUE (${{ steps.age-key-check.outputs.vault_days }} days old)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.age-key-check.outputs.vault_status }}" = "warning" ]; then
            echo "âš ï¸  **Ansible Vault**: Rotation due soon ($(( 365 - ${{ steps.age-key-check.outputs.vault_days }} )) days remaining)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.age-key-check.outputs.vault_status }}" = "ok" ]; then
            echo "âœ… **Ansible Vault**: OK (${{ steps.age-key-check.outputs.vault_days }} days old)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # SOPS Configuration
          if [ "${{ steps.sops-check.outputs.sops_status }}" = "ok" ]; then
            echo "âœ… **SOPS Config**: Found with ${{ steps.sops-check.outputs.age_key_count }} key(s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  **SOPS Config**: ${{ steps.sops-check.outputs.sops_status }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [SECRETS.md](SECRETS.md) for rotation procedures." >> $GITHUB_STEP_SUMMARY
