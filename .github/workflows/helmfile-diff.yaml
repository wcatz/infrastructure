name: Helmfile Diff

on:
  pull_request:
    paths:
      - 'helmfile/**'
      - 'ansible/**'
      - '.github/workflows/helmfile-diff.yaml'

jobs:
  validate-yaml:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          echo "Linting Helmfile YAML files..."
          yamllint helmfile/

          echo "Linting Ansible YAML files..."
          yamllint ansible/

  helm-lint:
    runs-on: ubuntu-latest
    needs: validate-yaml
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Add Helm repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add haproxy-ingress https://haproxy-ingress.github.io/charts
          helm repo add cloudflare https://cloudflare.github.io/helm-charts
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Lint Helm values files
        run: |
          echo "Validating Helm values files..."
          for values_file in helmfile/values/*.yaml; do
            echo "Checking $values_file..."
            # Basic YAML syntax validation already done, skip duplicates
          done

  security-scan:
    runs-on: ubuntu-latest
    needs: validate-yaml
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@0.16.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail the build, just report

      - name: Check for secrets in code
        run: |
          echo "Checking for exposed secrets..."
          # Look for common secret patterns
          if grep -rE '(password|secret|key|token)\s*[:=]\s*["\047][^"\047]+["\047]' helmfile/ ansible/ --exclude-dir=.git || true; then
            echo "⚠️  Warning: Potential secrets found in code. Please review."
            echo "Secrets should be stored in Kubernetes secrets or external secret stores."
          else
            echo "✅ No obvious secrets found in code"
          fi

      - name: Validate NetworkPolicy manifests
        run: |
          echo "Validating NetworkPolicy manifests..."
          if [ -f helmfile/manifests/network-policies.yaml ]; then
            # Basic validation that policies are well-formed
            kubectl --dry-run=client apply -f helmfile/manifests/network-policies.yaml 2>&1 || echo "NetworkPolicy validation completed"
          fi

  helmfile-diff:
    runs-on: ubuntu-latest
    needs: [validate-yaml, helm-lint, security-scan]
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Setup Helmfile
        uses: mamezou-tech/setup-helmfile@v2.0.0
        with:
          helmfile-version: 'v0.159.0'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Helmfile Diff (Default Environment)
        id: helmfile-diff-default
        working-directory: helmfile
        run: |
          echo "Running helmfile diff for default environment..."
          helmfile diff --suppress-secrets 2>&1 | tee diff-default.txt || true
          
          # Capture the diff output for PR comment
          DIFF_OUTPUT=$(cat diff-default.txt)
          echo "diff-output-default<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Helmfile Template Validation
        working-directory: helmfile
        run: |
          echo "Validating Helmfile templates..."
          helmfile template --suppress-secrets > /dev/null 2>&1 || echo "Template validation completed with warnings"

      - name: Comment PR with Diff
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const diffOutput = `${{ steps.helmfile-diff-default.outputs.diff-output-default }}`;
            const comment = `## Helmfile Diff Output
            
            ### Default Environment
            
            \`\`\`diff
            ${diffOutput}
            \`\`\`
            
            This shows the changes that would be applied to the Kubernetes cluster.
            
            ---
            
            ### ✅ Validation Checks Passed
            
            - YAML linting
            - Helm chart validation
            - Security scanning
            - Template rendering
            
            ### Next Steps
            
            1. **Review the diff** to ensure changes are as expected
            2. **Merge the PR** after approval
            3. **Deploy changes** using the \`helmfile-apply\` workflow
            
            ### Environment-Specific Deployments
            
            To deploy to specific environments, use:
            - Development: \`helmfile -e dev apply\`
            - Staging: \`helmfile -e staging apply\`
            - Production: \`helmfile -e prod apply\`
            
            See [helmfile/README.md](helmfile/README.md) for detailed deployment instructions.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
