name: Helmfile Diff

on:
  pull_request:
    paths:
      - 'helmfile/**'
      - 'ansible/**'
      - '.github/workflows/helmfile-diff.yaml'

jobs:
  validate-yaml:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          echo "Linting Helmfile YAML files..."
          find helmfile -name '*.yaml' -o -name '*.yml' | xargs yamllint -d "{extends: default, rules: {line-length: {max: 120}, document-start: disable}}" || true
          
          echo "Linting Ansible YAML files..."
          find ansible -name '*.yaml' -o -name '*.yml' | xargs yamllint -d "{extends: default, rules: {line-length: {max: 120}, document-start: disable}}" || true

  helmfile-diff:
    runs-on: ubuntu-latest
    needs: validate-yaml
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helmfile
        uses: mamezou-tech/setup-helmfile@v2.0.0
        with:
          helmfile-version: 'v0.159.0'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Helmfile Diff (Default Environment)
        id: helmfile-diff-default
        working-directory: helmfile
        run: |
          echo "Running helmfile diff for default environment..."
          helmfile diff --suppress-secrets 2>&1 | tee diff-default.txt || true
          
          # Capture the diff output for PR comment
          DIFF_OUTPUT=$(cat diff-default.txt)
          echo "diff-output-default<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Helmfile Template Validation
        working-directory: helmfile
        run: |
          echo "Validating Helmfile templates..."
          helmfile template --suppress-secrets > /dev/null 2>&1 || echo "Template validation completed with warnings"

      - name: Comment PR with Diff
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const diffOutput = `${{ steps.helmfile-diff-default.outputs.diff-output-default }}`;
            const comment = `## Helmfile Diff Output
            
            ### Default Environment
            
            \`\`\`diff
            ${diffOutput}
            \`\`\`
            
            This shows the changes that would be applied to the Kubernetes cluster.
            
            ---
            
            ### Next Steps
            
            1. **Review the diff** to ensure changes are as expected
            2. **Merge the PR** after approval
            3. **Deploy changes** using the \`helmfile-apply\` workflow
            
            ### Environment-Specific Deployments
            
            To deploy to specific environments, use:
            - Development: \`helmfile -e dev apply\`
            - Staging: \`helmfile -e staging apply\`
            - Production: \`helmfile -e prod apply\`
            
            See [helmfile/README.md](helmfile/README.md) for detailed deployment instructions.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
