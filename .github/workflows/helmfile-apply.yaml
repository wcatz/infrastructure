name: Helmfile Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'default'
        type: choice
        options:
          - default
          - dev
          - staging
          - production

# Use OIDC for secure authentication instead of long-lived credentials
permissions:
  contents: read
  id-token: write  # Required for OIDC

jobs:
  validate-before-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          echo "Linting Helmfile YAML files..."
          yamllint helmfile/

          echo "✅ YAML validation passed"

  helmfile-apply:
    runs-on: ubuntu-latest
    needs: validate-before-deploy
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write  # Required for OIDC
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # OIDC Authentication for AWS (if using AWS)
      # Uncomment and configure for AWS-based infrastructure
      # - name: Configure AWS Credentials (OIDC)
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: arn:aws:iam::ACCOUNT_ID:role/github-actions-role
      #     role-session-name: helmfile-deploy-${{ github.run_id }}
      #     aws-region: us-west-2

      # OIDC Authentication for Azure (if using Azure)
      # Uncomment and configure for Azure-based infrastructure
      # - name: Azure Login (OIDC)
      #   uses: azure/login@v1
      #   with:
      #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
      #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # OIDC Authentication for GCP (if using GCP)
      # Uncomment and configure for GCP-based infrastructure
      # - name: Authenticate to GCP (OIDC)
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: 'projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID'
      #     service_account: 'github-actions@PROJECT_ID.iam.gserviceaccount.com'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Setup Helmfile
        uses: mamezou-tech/setup-helmfile@v2.0.0
        with:
          helmfile-version: 'v0.159.0'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Setup SOPS
        run: |
          # Install SOPS for secret decryption with age encryption
          wget -O /usr/local/bin/sops https://github.com/mozilla/sops/releases/download/v3.8.1/sops-v3.8.1.linux.amd64
          chmod +x /usr/local/bin/sops
          sops --version

      - name: Setup age for SOPS decryption
        run: |
          # Install age for SOPS encryption/decryption
          wget https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz
          tar xzf age-v1.1.1-linux-amd64.tar.gz
          sudo mv age/age age/age-keygen /usr/local/bin/
          age --version

      - name: Configure SOPS Age Key (from GitHub Encrypted Secrets)
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          # Configure age key for SOPS decryption from GitHub encrypted secrets
          # The SOPS_AGE_KEY secret should contain the private key from ~/.config/sops/age/keys.txt
          # This is stored as an encrypted secret in GitHub Actions (not in repository)
          # Rotation: Update this secret quarterly (see SECRETS.md for rotation procedures)
          mkdir -p ~/.config/sops/age
          echo "$SOPS_AGE_KEY" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

          # Verify SOPS can read the key
          echo "SOPS age key configured successfully"

      - name: Configure Kubernetes Context
        run: |
          # This is a placeholder for configuring kubectl context
          # In a real scenario, you would configure kubeconfig here
          # Example:
          # echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          echo "Note: Configure your Kubernetes cluster credentials via repository secrets"
          echo "Set KUBECONFIG secret with base64-encoded kubeconfig content"

      - name: Helmfile Diff (Pre-deployment)
        working-directory: helmfile
        run: |
          echo "Running helmfile diff for environment: ${{ github.event.inputs.environment }}"
          if [ "${{ github.event.inputs.environment }}" = "default" ]; then
            helmfile diff --suppress-secrets || true
          else
            helmfile -e ${{ github.event.inputs.environment }} diff --suppress-secrets || true
          fi

      - name: Helmfile Apply
        working-directory: helmfile
        run: |
          echo "Running helmfile apply for environment: ${{ github.event.inputs.environment }}"
          if [ "${{ github.event.inputs.environment }}" = "default" ]; then
            helmfile apply --suppress-secrets
          else
            helmfile -e ${{ github.event.inputs.environment }} apply --suppress-secrets
          fi

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          # Add verification commands here
          # kubectl get pods -A
          # kubectl get svc -A

      - name: Deployment Summary
        run: |
          echo "✅ Helmfile deployment completed successfully"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
