name: Helmfile Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'default'
        type: choice
        options:
          - default
          - dev
          - staging
          - production

jobs:
  validate-before-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          echo "Linting Helmfile YAML files..."
          yamllint helmfile/

          echo "✅ YAML validation passed"

  helmfile-apply:
    runs-on: ubuntu-latest
    needs: validate-before-deploy
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helmfile
        uses: mamezou-tech/setup-helmfile@v2.0.0
        with:
          helmfile-version: 'v0.159.0'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Configure Kubernetes Context
        run: |
          # This is a placeholder for configuring kubectl context
          # In a real scenario, you would configure kubeconfig here
          # Example:
          # echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          echo "Note: Configure your Kubernetes cluster credentials via repository secrets"
          echo "Set KUBECONFIG secret with base64-encoded kubeconfig content"

      - name: Helmfile Diff (Pre-deployment)
        working-directory: helmfile
        run: |
          echo "Running helmfile diff for environment: ${{ github.event.inputs.environment }}"
          if [ "${{ github.event.inputs.environment }}" = "default" ]; then
            helmfile diff --suppress-secrets || true
          else
            helmfile -e ${{ github.event.inputs.environment }} diff --suppress-secrets || true
          fi

      - name: Helmfile Apply
        working-directory: helmfile
        run: |
          echo "Running helmfile apply for environment: ${{ github.event.inputs.environment }}"
          if [ "${{ github.event.inputs.environment }}" = "default" ]; then
            helmfile apply --suppress-secrets
          else
            helmfile -e ${{ github.event.inputs.environment }} apply --suppress-secrets
          fi

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          # Add verification commands here
          # kubectl get pods -A
          # kubectl get svc -A

      - name: Deployment Summary
        run: |
          echo "✅ Helmfile deployment completed successfully"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
